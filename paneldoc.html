<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Panel Doctor - SomaFix</title>
    <link rel="stylesheet" href="css/mitodo.css">
    <script src="datos_pacientes.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .modal-bg {
            position: fixed;
            inset: 0;
            background: rgba(40,60,90,0.25);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-bg.active {
            display: flex;
        }
        .modal {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 8px 32px #5b7fff33;
            padding: 32px 24px 24px 24px;
            max-width: 90vw;
            min-width: 340px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalIn 0.5s cubic-bezier(.68,-0.55,.27,1.55);
        }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.8);}
            to   { opacity: 1; transform: scale(1);}
        }
        .modal-close {
            position: absolute;
            top: 16px; right: 18px;
            font-size: 1.7rem;
            color: #5b7fff;
            cursor: pointer;
            font-weight: bold;
            transition: color 0.2s;
        }
        .modal-close:hover {
            color: #ff4d4d;
        }
        .tabla-dinamica {
            border-collapse: collapse;
            margin: 0 auto 24px auto;
            background: #f8fafc;
            font-size: 1rem;
        }
        .tabla-dinamica th, .tabla-dinamica td {
            border: 1px solid #b5c7e7;
            padding: 7px 10px;
            text-align: center;
        }
        .tabla-dinamica th {
            background: #e0e7ef;
            font-weight: 600;
        }
        .tabla-dinamica tr:hover td {
            background: #f0f4fa;
        }
        .grafico-container {
            max-width: 600px;
            margin: 30px auto 40px auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 12px #b5c7e733;
            padding: 24px 12px 12px 12px;
        }
        .apartado-comparativa {
            margin-top: 60px;
            padding: 24px 12px;
            background: #f5f7fa;
            border-radius: 18px;
            box-shadow: 0 2px 12px #b5c7e722;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
        }
        .info-paciente {
            margin-bottom:18px; 
            text-align:left; 
            background:#f5f7fa; 
            border-radius:10px; 
            padding:12px 18px;
        }
        @media (max-width: 600px) {
            .modal { min-width: 0; padding: 12px 2vw 12px 2vw;}
            .grafico-container, .apartado-comparativa { padding: 10px 2vw;}
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Panel del Doctor</h1>
        <hr>
        <h2>Selecciona un paciente para ver sus resultados</h2>
        <select id="pacienteSelect">
            <option value="">-- Elige un paciente --</option>
            <option value="P001">P001</option>
            <option value="P002">P002</option>
            <option value="P003">P003</option>
            <option value="P004">P004</option>
            <option value="P005">P005</option>
            <option value="P006">P006</option>
            <option value="P007">P007</option>
        </select>
        <button class="btn" onclick="window.history.back()" style="margin-top:30px;">Volver</button>
        <div class="apartado-comparativa">
            <h2 style="text-align:center;">Comparativa de mejora entre pacientes</h2>
            <canvas id="graficoComparativa" style="max-width:100%;"></canvas>
        </div>
    </div>
    <!-- Modal para resultados de paciente -->
    <div class="modal-bg" id="modalPaciente">
        <div class="modal">
            <span class="modal-close" onclick="cerrarModal()">&times;</span>
            <h2 id="modalTitulo"></h2>
            <div id="tablaModal"></div>
            <div class="grafico-container">
                <canvas id="graficoDolor" style="max-width:100%;"></canvas>
            </div>
        </div>
    </div>
    <script>
    // --- Información básica de los pacientes ---
    const infoPacientes = {
        P001: { nombre: "P001", edad: 52, diagnostico: "Cervicalgia crónica", grupo: "Ondas" },
        P002: { nombre: "P002", edad: 47, diagnostico: "Dolor neuropático", grupo: "Ondas" },
        P003: { nombre: "P003", edad: 60, diagnostico: "Ciática", grupo: "Ondas" },
        P004: { nombre: "P004", edad: 55, diagnostico: "Lumbalgia crónica", grupo: "Ondas" },
        P005: { nombre: "P005", edad: 49, diagnostico: "Lumbalgia crónica", grupo: "Música" },
        P006: { nombre: "P006", edad: 44, diagnostico: "Fibromialgia y depresión", grupo: "Música" },
        P007: { nombre: "P007", edad: 38, diagnostico: "Migraña crónica y depresión", grupo: "Música" }
    };

    function cerrarModal() {
        document.getElementById('modalPaciente').classList.remove('active');
        if (window.graficoDolorObj) window.graficoDolorObj.destroy();
    }

    document.getElementById('pacienteSelect').onchange = function() {
        let nombre = this.value;
        if (!nombre) return cerrarModal();
        let mes = "2025-07";
        let dias = 31;
        let datos = [];
        for (let d = 1; d <= dias; d++) {
            let diaStr = d.toString().padStart(2, '0');
            let fecha = mes + '-' + diaStr;
            let key = "calendario_" + nombre + "_" + fecha;
            let lista = JSON.parse(localStorage.getItem(key) || "[]");
            if (lista.length > 0) {
                let reg = lista[0];
                reg.fecha = fecha;
                datos.push(reg);
            }
        }
        if (!datos.length) {
            document.getElementById('tablaModal').innerHTML = "<p>No hay registros para este paciente.</p>";
            document.getElementById('modalTitulo').textContent = "";
            document.getElementById('modalPaciente').classList.add('active');
            return;
        }

        // --- Info paciente ---
        let info = infoPacientes[nombre];
        let infoHtml = `
            <div class="info-paciente">
                <b>Nombre:</b> ${info.nombre}<br>
                <b>Edad:</b> ${info.edad} años<br>
                <b>Diagnóstico:</b> ${info.diagnostico}<br>
                <b>Grupo:</b> ${info.grupo}
            </div>
        `;

        // Preguntas a mostrar
        const preguntas = [
            {campo:"dolorMin", texto:"Dolor mínimo"},
            {campo:"dolorMax", texto:"Dolor máximo"},
            {campo:"emocion", texto:"Emoción"},
            {campo:"afectaActividades", texto:"Afecta actividades"},
            {campo:"sueno", texto:"Sueño"},
            {campo:"musicaHoy", texto:"Música hoy"},
            {campo:"movilidad", texto:"Movilidad"},
            {campo:"momentoPeorDolor", texto:"Peor momento"},
            {campo:"tiempoDolor", texto:"Tiempo dolor"}
        ];

        // Tabla dinámica: días arriba, preguntas a la izquierda
        let tabla = `<table class="tabla-dinamica"><thead><tr><th>Pregunta / Día</th>`;
        datos.forEach(reg => {
            tabla += `<th>${reg.fecha.slice(-2)}</th>`;
        });
        tabla += `</tr></thead><tbody>`;
        preguntas.forEach(p => {
            tabla += `<tr><th>${p.texto}</th>`;
            datos.forEach(reg => {
                tabla += `<td>${reg[p.campo] ?? ''}</td>`;
            });
            tabla += `</tr>`;
        });
        tabla += `</tbody></table>`;
        document.getElementById('tablaModal').innerHTML = infoHtml + tabla;
        document.getElementById('modalTitulo').textContent = `Resultados de ${nombre} (Julio 2025)`;
        document.getElementById('modalPaciente').classList.add('active');

        // Gráfico de dolor
        let labels = datos.map(r => r.fecha.slice(-2));
        let dolorMin = datos.map(r => r.dolorMin ?? null);
        let dolorMax = datos.map(r => r.dolorMax ?? null);
        let ctx = document.getElementById('graficoDolor').getContext('2d');
        if (window.graficoDolorObj) window.graficoDolorObj.destroy();
        window.graficoDolorObj = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Dolor mínimo', data: dolorMin, borderColor: '#4fd1c5', backgroundColor: '#4fd1c588', fill: false, tension: 0.2 },
                    { label: 'Dolor máximo', data: dolorMax, borderColor: '#5b7fff', backgroundColor: '#5b7fff88', fill: false, tension: 0.2 }
                ]
            },
            options: {
                plugins: { legend: { position: 'top' } },
                scales: { y: { min: 0, max: 10, title: { display: true, text: 'Dolor (0-10)' } } }
            }
        });
    };

    // --- Comparativa de mejora entre pacientes ---
    function mostrarComparativa() {
        // Simulación: la mayoría mejora poco, uno no mejora nada (P004)
        let pacientes = [
            {id:"P001", nombre:"P001"}, {id:"P002", nombre:"P002"}, {id:"P003", nombre:"P003"}, {id:"P004", nombre:"P004"},
            {id:"P005", nombre:"P005"}, {id:"P006", nombre:"P006"}, {id:"P007", nombre:"P007"}
        ];
        let mes = "2025-07";
        // Puedes ajustar estos valores para que se vea el cambio mínimo
        let dolorInicio = [8, 7, 6, 9, 7, 8, 6];
        let dolorFin    = [7, 6, 5, 9, 6, 7, 5]; // P004 no mejora (9->9), los demás bajan 1 punto
        let grupo = ["Ondas","Ondas","Ondas","Ondas","Música","Música","Música"];
        let ctx = document.getElementById('graficoComparativa').getContext('2d');
        if (window.graficoComparativaObj) window.graficoComparativaObj.destroy();
        window.graficoComparativaObj = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: pacientes.map(p=>p.nombre),
                datasets: [
                    { label: 'Dolor máximo Día 1', data: dolorInicio, backgroundColor: grupo.map(g=>g=="Música"?"#4fd1c5":"#5b7fff") },
                    { label: 'Dolor máximo Día 31', data: dolorFin, backgroundColor: grupo.map(g=>g=="Música"?"#4fd1c588":"#5b7fff88") }
                ]
            },
            options: {
                plugins: { legend: { position: 'top' } },
                scales: { y: { min: 0, max: 10, title: { display: true, text: 'Dolor máximo (0-10)' } } }
            }
        });
    }
    mostrarComparativa();
    </script>
</body>
</html>
